name: LLM-Powered Code Review + SonarQube

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review-and-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Extract PR diff and number
        id: diff
        run: |
          DIFF=$(python3 -c 'from reviewer.diff_extractor import extract_diff; print(extract_diff().replace("%", "%%"))')
          PR_NUMBER=$(python3 -c 'from reviewer.diff_extractor import get_pr_info; print(get_pr_info()["pr_number"])')
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Call LLM for review
        id: llm
        run: |
          python3 - <<'EOF'
          import os, json
          from reviewer.llm_reviewer import call_openai_llm

          diff_text = os.environ.get("DIFF_TEXT", "")
          comments, _ = call_openai_llm(diff_text)
          with open("llm_comments.json", "w") as f:
              json.dump(comments, f)
          EOF
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF_TEXT: ${{ steps.diff.outputs.diff }}

      - name: Post comments to GitHub
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MY_GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const comments = JSON.parse(fs.readFileSync('llm_comments.json', 'utf8'));
            const pr_number = parseInt('${{ steps.diff.outputs.pr_number }}');
            for (const c of comments) {
              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr_number,
                body: c.comment,
                path: c.file_path,
                line: c.line,
                side: 'RIGHT'
              });
            }

      - name: Download and set up SonarScanner
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
          unzip sonar-scanner-cli-4.8.0.2856-linux.zip
          echo "${PWD}/sonar-scanner-4.8.0.2856-linux/bin" >> $GITHUB_PATH

      - name: Run SonarQube Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          sonar-scanner -Dsonar.login=$SONAR_TOKEN \
                        -Dsonar.host.url=$SONAR_HOST_URL \
                        -Dsonar.projectKey=${{ github.repository }} \
                        -Dsonar.sources=.

      - name: Fetch SonarQube Metrics & Aggregate
        run: |
          python3 - <<'EOF'
          from reviewer.sonar_wrapper import wait_for_sonar_analysis, fetch_sonar_metrics, aggregate_and_write_report
          from reviewer.diff_extractor import get_pr_info
          import json

          pr_info = get_pr_info()
          sonar_key = pr_info["repo_full_name"].replace("/", "_")
          metrics = fetch_sonar_metrics(sonar_key)
          with open("llm_comments.json", "r") as f:
              llm_comments = json.load(f)
          # For demonstration, we use empty SonarQube issues and a dummy markdown
          sonar_report_md = "SonarQube metrics: " + str(metrics)
          llm_feedback_md = "LLM comments: " + str(llm_comments)
          output_file = f"review_summary_pr_{pr_info['pr_number']}.md"
          aggregate_and_write_report(llm_feedback_md, sonar_report_md, pr_info["pr_number"], output_file)
          EOF

      - name: Upload Summary Artifact
        uses: actions/upload-artifact@v3
        with:
          name: review-summary
          path: review_summary_pr_${{ steps.diff.outputs.pr_number }}.md
